Summary: qemu-dm device model
Name: xen-device-model
Version: @IOEMU_VERSION@
Release: @IOEMU_RELEASE@
License: GPL
Group: System/Hypervisor
Source0: xen-device-model-%{version}.tar.bz2
Patch0: xen-device-model-development.patch
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-buildroot
BuildRequires: zlib-devel, xen-libs-devel, xen-dom0-libs-devel, pciutils-devel, libpciaccess-devel, check-devel
Requires(pre): shadow-utils
Requires: libdrm
Provides: qemu-xen(syslog) = 1

%description
This package contains qemu-dm, the Xen device model.
%prep
%setup -q
%patch0 -p1

%build
./xen-setup --disable-opengl --disable-vnc-tls --disable-blobs --disable-sdl --enable-werror
%{?cov_wrap} %{__make}
%{__make} unittests

%install
rm -rf $RPM_BUILD_ROOT
%{?cov_wrap} %{__make} install DESTDIR=$RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/var/xen/qemu

# CA-157601 - Leave Qemu where xenops expects to find it until qemu-dm-wrapper can be fixed
mkdir -p $RPM_BUILD_ROOT%{_libdir}/xen/bin/
ln $RPM_BUILD_ROOT%{_libexecdir}/xen/bin/qemu-dm $RPM_BUILD_ROOT%{_libdir}/xen/bin/qemu-dm

%clean
rm -rf $RPM_BUILD_ROOT

%pre
/usr/bin/getent passwd qemu >/dev/null 2>&1 || /usr/sbin/useradd \
    -M -U -r \
    -s /sbin/nologin \
    -d / \
    qemu >/dev/null 2>&1 || :
/usr/bin/getent passwd qemu_base >/dev/null 2>&1 || /usr/sbin/useradd \
    -M -U -r \
    -s /sbin/nologin \
    -d / \
    -u 65535 \
    qemu_base >/dev/null 2>&1 || :

%files
%defattr(-,root,root,-)
%doc
%{_libexecdir}/xen/bin/qemu-dm
# CA-157601 - Leave Qemu where xenops expects to find it until qemu-dm-wrapper can be fixed
%{_libdir}/xen/bin/qemu-dm
%{_datadir}/xen/qemu/keymaps
%exclude /etc/xen/scripts/qemu-ifup
%dir /var/xen/qemu

%changelog
